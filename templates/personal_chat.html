{% extends "base.html" %}
{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
{% endblock %}
{% block content %}
<h2>Private Chat with {{ recipient.username }}</h2>
<div id="private-chat-box" style="height:300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px;">
  {% for msg in messages %}
    <p>
      <strong>
        {% if msg.sender_id == current_user.id %}
          You
        {% else %}
          {{ recipient.username }}
        {% endif %}
      :</strong> {{ msg.message }}
      <small>({{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }})</small>
    </p>
  {% endfor %}
</div>
<form id="private-chat-form">
    {{ form.hidden_tag() }}
    <div class="form-group">
        {{ form.message(class="form-control", placeholder="Type your message here...") }}
    </div>
    <button type="submit" class="btn btn-primary">Send</button>
</form>
{% endblock %}
{% block scripts %}
<script type="text/javascript">
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
    
    socket.on('connect', function() {
        console.log("[DEBUG] Socket connected (private chat).");
        // Join both the personal room and the private chat room.
        socket.emit('join_user', { username: "{{ current_user.username }}" });
        socket.emit('join_private', { sender: "{{ current_user.username }}", recipient: "{{ recipient.username }}" });
    });
    
    const privateChatForm = document.getElementById('private-chat-form');
    const privateChatBox = document.getElementById('private-chat-box');

    privateChatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const messageInput = privateChatForm.querySelector('textarea');
        const message = messageInput.value;
        if (message.trim() !== '') {
            socket.emit('send_private_message', {
                message: message,
                sender: "{{ current_user.username }}",
                recipient: "{{ recipient.username }}"
            });
            messageInput.value = '';
        }
    });

    socket.on('receive_private_message', function(data) {
        console.log("[DEBUG] Received private message:", data);
        const p = document.createElement('p');
        p.innerHTML = '<strong>' + data.sender + ':</strong> ' + data.message +
                      ' <small>(' + data.timestamp + ')</small>';
        privateChatBox.appendChild(p);
        privateChatBox.scrollTop = privateChatBox.scrollHeight;
    });

    socket.on('private_chat_rejected', function(data) {
        alert(data.msg);
    });

    socket.on('error', function(data) {
        console.error("[DEBUG] Error:", data.error);
        alert(data.error);
    });
</script>
{% endblock %}
