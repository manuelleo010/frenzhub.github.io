{% extends "base.html" %}
{% block content %}
<h2>Private Chat with {{ recipient.username }}</h2>
<div id="private-chat-box">
  {% for msg in messages %}
    <p>
      <strong>
        {% if msg.sender_id == current_user.id %}
          You
        {% else %}
          {{ recipient.username }}
        {% endif %}
      :</strong>
      {% if msg.message %}{{ msg.message }}{% endif %}
      {% if msg.file_url %}
         <br>
         {% if msg.file_type == "image" %}
           <img src="{{ msg.file_url }}" alt="Image" style="max-width:200px;">
         {% else %}
           <video src="{{ msg.file_url }}" controls style="max-width:200px;"></video>
         {% endif %}
      {% endif %}
      <small>({{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }})</small>
    </p>
  {% endfor %}
</div>
<form id="private-chat-form" enctype="multipart/form-data">
    {{ form.hidden_tag() }}
    {{ form.message(class="form-control", placeholder="Type your message here...") }}
    <!-- Attachment icon -->
    <span class="attachment-icon" onclick="document.getElementById('private-media-file').click();">&#128206;</span>
    <!-- Hidden file input -->
    <input type="file" id="private-media-file" class="hidden-file-input" accept="image/*,video/*">
    <input type="hidden" id="private_file_url" value="">
    <input type="hidden" id="private_file_type" value="">
    <button type="submit" class="btn btn-primary">Send</button>
</form>
{% endblock %}
{% block scripts %}
<script type="text/javascript">
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
    
    socket.on('connect', function() {
        console.log("[DEBUG] Socket connected (private chat).");
        socket.emit('join_user', { username: "{{ current_user.username }}" });
        socket.emit('join_private', { sender: "{{ current_user.username }}", recipient: "{{ recipient.username }}" });
    });
    
    const privateChatForm = document.getElementById('private-chat-form');
    const privateChatBox = document.getElementById('private-chat-box');
    const privateMediaInput = document.getElementById('private-media-file');
    const privateFileUrlField = document.getElementById('private_file_url');
    const privateFileTypeField = document.getElementById('private_file_type');
    
    privateMediaInput.onchange = function() {
        var file = privateMediaInput.files[0];
        if (!file) return;
        var formData = new FormData();
        formData.append('file', file);
        fetch("{{ url_for('main.upload_media') }}", {
            method: 'POST',
            body: formData,
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                privateFileUrlField.value = data.file_url;
                privateFileTypeField.value = data.file_type;
            }
        })
        .catch(err => console.error(err));
    };
    
    privateChatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const messageText = privateChatForm.querySelector('textarea').value;
        const file_url = privateFileUrlField.value;
        const file_type = privateFileTypeField.value;
        socket.emit('send_private_message', { 
            message: messageText, 
            sender: "{{ current_user.username }}", 
            recipient: "{{ recipient.username }}",
            file_url: file_url,
            file_type: file_type
        });
        privateChatForm.querySelector('textarea').value = "";
        privateMediaInput.value = "";
        privateFileUrlField.value = "";
        privateFileTypeField.value = "";
    });
    
    socket.on('receive_private_message', function(data) {
        console.log("[DEBUG] Received private message:", data);
        var p = document.createElement('p');
        p.innerHTML = '<strong>' + data.sender + ':</strong> ' + (data.message || "");
        if (data.file_url) {
            if (data.file_type === "image") {
                p.innerHTML += '<br><img src="' + data.file_url + '" alt="Image" style="max-width:200px;">';
            } else {
                p.innerHTML += '<br><video src="' + data.file_url + '" controls style="max-width:200px;"></video>';
            }
        }
        p.innerHTML += ' <small>(' + data.timestamp + ')</small>';
        privateChatBox.appendChild(p);
        privateChatBox.scrollTop = privateChatBox.scrollHeight;
    });
    
    socket.on('private_chat_rejected', function(data) {
        alert(data.msg);
    });
    
    socket.on('error', function(data) {
        console.error("[DEBUG] Error:", data.error);
        alert(data.error);
    });
</script>
{% endblock %}
