{% extends "base.html" %}
{% block content %}
<h2>Private Chat with {{ recipient.username }}</h2>
<div id="private-chat-box" style="height:450px; overflow-y:auto; border:1px solid #ddd; padding:10px;">
  {% for msg in messages %}
    <p>
      <strong>
        {% if msg.sender_id == current_user.id %}
          You
        {% else %}
          {{ recipient.username }}
        {% endif %}
      :</strong> {{ msg.message }}
      <small>({{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }})</small>
    </p>
  {% endfor %}
</div>
<form id="private-chat-form">
    {{ form.hidden_tag() }}
    {{ form.message(class="form-control", placeholder="Type your message here...") }}
    <button type="submit" class="btn btn-primary">Send</button>
</form>
{% endblock %}
{% block scripts %}
<script>
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
    socket.on('connect', function(){
        console.log("Socket connected in private chat");
        socket.emit('join_user', {username: "{{ current_user.username }}"});
        socket.emit('join_private', {sender: "{{ current_user.username }}", recipient: "{{ recipient.username }}"});
    });
    
    var chatForm = document.getElementById('private-chat-form');
    var chatBox = document.getElementById('private-chat-box');
    
    chatForm.addEventListener('submit', function(e){
        e.preventDefault();
        var msg = chatForm.querySelector('textarea').value;
        if(msg.trim() === "") return;
        socket.emit('send_private_message', {message: msg, sender: "{{ current_user.username }}", recipient: "{{ recipient.username }}"});
        chatForm.querySelector('textarea').value = "";
    });
    
    socket.on('receive_private_message', function(data){
        console.log("Received private message:", data);
        var p = document.createElement('p');
        p.innerHTML = "<strong>" + data.sender + ":</strong> " + data.message + " <small>(" + data.timestamp + ")</small>";
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
    });
    
    socket.on('error', function(data){
        alert(data.error);
    });
</script>
{% endblock %}
