{% extends "base.html" %}
{% block content %}
<h2>Common Chat Room</h2>
<div id="chat-box" style="height:450px; overflow-y:auto; border:1px solid #ddd; padding:10px;">
  {% for msg in messages %}
    <p>
      <strong>
        {% if msg.username != current_user.username %}
          <a href="{{ url_for('main.personal_chat', username=msg.username) }}">{{ msg.username }}</a>
        {% else %}
          {{ msg.username }}
        {% endif %}
      :</strong> {{ msg.message }}
      <small>({{ msg.timestamp.strftime('%Y-%m-%d %H:%M') }})</small>
    </p>
  {% endfor %}
</div>
<form id="chat-form">
    {{ form.hidden_tag() }}
    {{ form.message(class="form-control", placeholder="Type your message here...") }}
    <button type="submit" class="btn btn-primary">Send</button>
</form>
{% endblock %}
{% block scripts %}
<script>
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
    socket.on('connect', function(){
        console.log("Socket connected in common chat");
        socket.emit('join_user', {username: "{{ current_user.username }}"});
    });
    
    var chatForm = document.getElementById('chat-form');
    var chatBox = document.getElementById('chat-box');
    
    chatForm.addEventListener('submit', function(e){
        e.preventDefault();
        var msg = chatForm.querySelector('textarea').value;
        if(msg.trim() === "") return;
        socket.emit('send_message', {message: msg, username: "{{ current_user.username }}"});
        chatForm.querySelector('textarea').value = "";
    });
    
    socket.on('receive_message', function(data){
        console.log("Received message:", data);
        var p = document.createElement('p');
        p.innerHTML = "<strong>" + data.username + ":</strong> " + data.message + " <small>(" + data.timestamp + ")</small>";
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
    });
    
    socket.on('error', function(data){
        alert(data.error);
    });
</script>
{% endblock %}
